# Интеграция с 1С-Коннект

## Настройка интеграции

1. УФФ С&К -> Сервис -> Настройки подсистемы -> Настройки 1С-Коннект -> Создать.
2. Тип настроек = "Данные авторизации";
3. Установка Логина и Пароля.
Чтобы получить логин и пароль, нужно взять их из учетной системы 1С-Коннект. Если ранее не создавались учетные записи API, нужно создать учетную запись в Настройках API 1С-Коннект:
    * [Учетная система 1С-Коннект](<https://cus.buhphone.com/>) -> Администрирование -> Настройки API -> Новая учетная запись.
    * Укажите название, логин и пароль и сохраните.
Созданный логин и пароль установите в созданных настройках 1С-Коннект.
4. УФФ С&К -> Справочники -> Линии поддержки -> Загрузить из 1С-Коннект.

## Импорт из 1С-Коннект

Создание записей в документе "Учет времени" на основе подключений по удаленному доступу из 1С-Коннект.

### Как работать

* УФФ С&К -> 1С-Коннект -> Импорт из 1С-Коннект
* Выберите получаемый период. **Внимание: При вызове операции в дневное время максимальное значение запрашиваемого периода не может превышать 60 календарных дней. Это особенность 1С-Коннект**
* Укажите номенклатуру, которая будет подставляться к создаваемым записям. Обычно это может быть услуга: например, оказание услуг по сопровождению.
* Нажмите на "Получить данные". Таблица заполнится списком подключений к клиентам за выбранный период.
Если комментарий к подключению не был указан в 1С-Коннект, его можно указать в списке.
Жирным шрифтом выделелены клиенты, у которых есть абонентский договор.
* Нажмите на "Создать документы". Создатся документ, в который внесутся работы из списка. Если в указанном периоде будет найден существующий документ, система предложит добавить данные в существующий документ.

## Интеграция параметров сопровождения

### Настройка интеграции

1. Должны быть заполнены авторизационные данные для доступа к API 1С-Коннект (см. Настройка интеграции).
2. Для выполнения настройки нужно, чтобы было доступно как минимум 4 свободных параметра 1С-Коннект.
Если все соответствует требованиям, выполните следующие действия:
УФФ С&К -> 1С-Коннект -> Параметры сопровождения 1С-Коннект -> Создать используемые дополнительные параметры.

### Передача параметров в 1С-Коннект

Выгрузка задолженности из 1С в 1С-Коннект.

Выгружаемые параметры:

**Стоимость услуг** - стоимость часа договора, рассчитывается по принципу, применяемому в отчете Учет рабочего времени.

**Задолженность** - значение задолженности по договорам клиента. Для корректного расчета в разделе "Настройки подсистемы" необходимо заполнить следующие настройки:

 *Дата начала получения договоров* - это дата, с которой отбираются все действующие договоры по текущий день.
 По этим договорам рассчитывается задолженность по документам.

 *Дата последней реализации* - это дата последнего выставленного документа "Расходная накладная" клиенту.
 На следующий день после этой даты рассчитывается задолженность по отработанному времени (см. отчет Учет рабочего времени).

Таким образом, расчет задолженности определяется следующим образом:
Задолженность по документам складывается с задолженностью по отработанному времени, которое начинается со следующего дня после последнего выставленного документа на оплату.

**Предоплата** - это значение, рассчитываемое аналогично задолженности по документам.

#### Как работать

* Для выгрузки задолженности нужно нажать на кнопку "Выгрузить задолженность". Если указать контрагента, то задолженность выгрузится только по нему, если значение пустое, то задолженность выгрузится по всем клиентам.

В таблице ниже отобразится информация о выгруженной задолженности.
В колонке "Сумма на дату реализации" отобразится задолженность по документам. То есть это задолженность рассчитанная программой.
В колонке "Сумма после даты реализации" отобразится задолженность по оказанным услугам клиенту уже после того, как был выставлен последний документ на оплату, т.е. задолженность по договору.

### Статус работы контрагента

Механизм основан на основе механизма статусов объектов.
Под капотом находятся статусы, в которых описаны роботы. По умолчанию статусы для контрагентов создаются автоматически. 

В роботах можно описать параметры действий. Например, если настроить робота "Отправить сообщение в линию поддержки", можно задать сообщение по шаблону, указать нужные параметры, которые подставятся во время выполнения робота. А в роботе "Изменить дополнительный параметр" вы можете изменить любой параметр, главное указать его идентификатор и нужное значение.
Таким образом, это дает возможность переопределить логику установки Статусов контрагентов на любую логику.
Роботов, созданных системой, можно увидеть в справочнике Статусы объектов -> Контрагенты -> Любой статус -> вкладка Роботы. Вы можете их изменить или удалить вообще и тогда при такой логике статус контрагента будет меняться только в программе.

На текущий момент доступны следующие роботы:

* Отправить сообщение в линию поддержки
* Отправить рассылку в линию поддержки
* Изменить дополнительный параметр

Если же вы хотите поработать с той бизнес-логикой, которую выстроили мы, вот описание:

Мастер установки Статуса контрагента выполняет рассылку сообщений об установке/снятии запрета на работу с клиентом. Рассылку можно делать как в линию к клиентам, так и в отдельно выделенную линию для сотрудников.

#### Настройка

Перейдите в УФФ С&К -> Сервис -> Настройки подсистемы -> Основные.

Для того, чтобы сообщения отправлялись клиентам в линию поддержки:

* Автор сообщений в 1С-Коннект -> Установите сотрудника.
При отправке сообщения автором сообщения будет указан установленный сотрудник.
Сотрудник из 1С сопоставится по Фамилии и дате рождения с пользователем из 1С-Коннект.

* Линия для отправки сообщений клиентам 1С-Коннект -> Выберите линию поддержки, куда отправлять сообщения клиентам. Тогда сообщения будут отправляться в линию поддержки для информирования клиентов.

* Линия для отправки сообщений сотрудникам 1С-Коннект -> Выберите линию поддержки, куда отправлять сообщения сотрудникам. Здесь вы можете выделить отдельную линию поддержки из 1С-Коннект так, чтобы ваши сотрудники получали поддержку в качестве пользователя, и доступ к этой линии иметь будут только они. Тогда при установленной настройке уведомления будут отправляться в эту линию для информирования сотрудников.

#### Как работать

Выберите клиента, кому нужно поменять статус. Снизу отобразится его текущий статус. Всего их 3:

 1. Работа разрешена;
 2. Работа запрещена;
 3. Работа разрешена по предоплате.

Если нужно указать причину запрета, то она указывается в поле "Причина". Список причин берется из УФФ С&К -> Сервис -> Настройки подсистемы -> Причины запрета.

Можно заполнить поле Комментарий. Его значение отправится в линию поддержки с сотрудниками, но клиенту комментарий не отправится.

Если статус не менялся, отобразится статус "Работа разрешена".

Для установки запрета нужно нажать на кнопку "Запретить работу".
Для снятия запрета нужно нажать на кнопку "Разрешить работу".
Для установки разрешения работы по предоплате нужно нажать на кнопку "Разрешить работу по предоплате".
Уведомления отправятся в линию поддержки с сотрудниками, если настройка заполнена.
Также, если включен параметр "Уведомлять клиента", то сообщение отправится клиенту.

Если нужно отправить уведомления сразу нескольким клиентам, нужно нажать на кнопку в виде списка рядом с полем Контрагент. Тогда можно будет выбрать нескольких клиентов.

Кроме отправки уведомления в контрагенте изменится статус. Его значение будет отображено в карточке контрагента. Кроме статуса еще отобразится дата и время установки статуса.
Также статус будет отображен в карточке звонка.

 1. Синий цвет - работа разрешена.
 2. Красный цвет - работа запрещена.
 3. Черный цвет - работа разрешена по предоплате.
 4. Ничего не написано - статус не менялся.

### Настройка статусов

Переходим по пути Статусы объектов -> Контрагенты -> Создать статус.

В элементе указываем название статуса.

Описание полей:

#### Раздел Основное: 

* Наименование - подставляется в название кнопок на форме установки статуса.
* Объект владелец - группа объекта, к которой принадлежит статус. В данном случае это группа Контрагенты.
* Группа владелец - текущая группа статусов. Изначально планировалось реализовать возможность создавать различные группы статусов объектов и делать переходы между ними, но на текущий момент это не реализовано.
* Родитель - группа внутри группы статусов, которой принадлежит статус.
* Описание - здесь можно задать описание статуса. Поле подставляется в карточку контрагента, где отображается статус.
* Цвет - установленный цвет отображается в карточке контрагента.
* Условие отображения. Здесь можно указывать условия отображения статуса на встроенном языке. В поле ввода доступен контекст объекта, которому принадлежит этот статус. Например, я могу указать, что отображать статус "В работе", если заполнен контрагент в документе расходная накладная таким выражением: 
"ЗначениеЗаполнено(Контрагент)". И тогда статус будет отображаться в объекте РН только при таком условии.
* Порядок - поле задает порядок статуса
* Идентификатор - служебное поле, характеризующее идентификатор статуса. Не редактируется пользователем.

### Раздел Роботы (beta):

* Робот добавляется по кнопке Добавить. Выбрав нужного робота в строке откроется его форма.
В доступных полях можно указывать идентификаторы полей объектов. На текущий момент редактор не так развит, и подсказки полей сейчас нет.

Доступные поля для вставки:

```

* Параметры.Контрагент. Из Контрагента можно получать значения его свойств по точке.
* Параметры.ЗапретНаРаботуСКлиентом.ПричинаЗапрета
* Параметры.ЗапретНаРаботуСКлиентом.Комментарий
* Параметры.ЗапретНаРаботуСКлиентом.ОтправлятьСообщениеКлиенту
* Параметры.ЗапретНаРаботуСКлиентом.Отправитель
* Параметры.ЗапретНаРаботуСКлиентом.ЛинияПоддержки

```
Также можно использовать перечисления конфигурации, системные перечисления, предопределенные элементы объектов.

Также рекомендуется заключать вставляемые выражения в квадратные скобки. Пример:
Ответственный по контрагенту: ```[Параметры.Контрагент.Ответственный]```.

На текущий момент можно использовать только методы глобального контекста.
Нельзя использовать условные операторы. Вместо классического Если-Иначе допускается использовать тернарный оператор ```?(<Условие>, <Значение если Истина>, <Значение если Ложь>)```.
Пример:

```

Мы очень рады работать с [
    ?(Параметры.Контрагент.СегментРынка = Перечисления.СК_БюджетХозрасчет.Бюджет),  
    "вашим учреждением",
    "вашей компанией"  
]. Благодарим за обращение. Были рады помочь.

```

Также мастер изменения статуса можно вызвать из карточки контрагента по кнопке "Изменить статус".
