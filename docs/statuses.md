# Статусы объектов

## Доступные объекты

* Документ `Расходная накладная`
* Справочник `Договоры контрагентов`
* Справочник `Контрагенты`

## Как создать статус

Статусы объектов -> Контрагенты -> Создать статус.

В элементе указываем название статуса.

Описание полей:

## Раздел Основное

* Наименование - подставляется в название кнопок на форме установки статуса.
* Объект владелец - группа объекта, к которой принадлежит статус. В данном случае это группа Контрагенты.
* Группа владелец - текущая группа статусов. Изначально планировалось реализовать возможность создавать различные группы статусов объектов и делать переходы между ними, но на текущий момент это не реализовано.
* Родитель - группа внутри группы статусов, которой принадлежит статус.
* Представление - здесь задать представление статуса.
* Отображать дату изменения состояния ЭДО как представление статуса (работает только для расходной накладной) - связь статуса с состояниями ЭДО. Если эта настройка включена, и например, документ дошел до определенного статуса, то тогда при изменении состояния ЭДО в списке документа вместо статуса будет отображаться дата изменения состояния ЭДО.
* Запретить изменение статуса из списка - устанавливает запрет на изменение статуса из списка.
* Цвет - установленный цвет отображается в карточке контрагента.
* Условие отображения. Здесь можно указывать условия отображения статуса на встроенном языке. В поле ввода доступен контекст объекта, которому принадлежит этот статус. Например, я могу указать, что отображать статус `В работе`, если заполнен контрагент в документе расходная накладная таким выражением:
`ЗначениеЗаполнено(Контрагент)`. И тогда статус будет отображаться в объекте РН только при таком условии.
* Порядок - поле задает порядок статуса
* Идентификатор - служебное поле, характеризующее идентификатор статуса. Не редактируется пользователем.

Менять статусы можно из карточки объектов.
Для документа `Расходная накладная`, справочника `Договоры контрагентов` статус изменить можно по кнопке `Статус` в карточке объекта.
Для справочника `Контрагенты` изменить статус можно по кнопке `Изменить статус`.

## Раздел Роботы (beta)

В роботах можно описать параметры действий. Например, если настроить робота `Отправить сообщение в линию поддержки`, можно задать сообщение по шаблону, указать нужные параметры, которые подставятся во время выполнения робота. А в роботе `Изменить дополнительный параметр` вы можете изменить любой параметр, главное указать его идентификатор и нужное значение.
Таким образом, это дает возможность переопределить логику установки Статусов контрагентов на любую логику.
Роботов, созданных системой, можно увидеть в справочнике `Статусы объектов -> Контрагенты -> Любой статус -> вкладка Роботы`. Вы можете их изменить или удалить вообще и тогда при такой логике статус контрагента будет меняться только в программе.

На текущий момент доступны следующие роботы:

* Отправить сообщение в линию поддержки
* Отправить рассылку в линию поддержки
* Отправить сообщение в группу
* Изменить дополнительный параметр
* Отправить сообщение сотруднику компании в 1С-Коннект
* Напомнить пользователю
* Отправить уведомление

## Как добавить робота

* Робот добавляется по кнопке Добавить. Выбрав нужного робота в строке откроется его форма.
В доступных полях можно указывать идентификаторы полей объектов. На текущий момент редактор не так развит, и подсказки полей сейчас нет.

## Доступные поля для вставки:

### Доступно для всех объектов:

#### Параметры.ИдентификаторКлиентаВКоннект

Тип значения: Строка

##### Описание

Идентификатор клиента в 1С-Коннект.

#### Параметры.НастройкиПодсистемы.АвторСообщений

Тип значения: Строка

##### Описание

Идентификатор сотрудника в 1С-Коннект из настроек.

#### Параметры.НастройкиПодсистемы.КодДистрибьтора
Тип значения: Строка

##### Описание

Код дистрибьтора из настроек

* Параметры.НастройкиПодсистемы.ЛинияПоддержкиДляОтправкиСообщенийКлиентам - Строка - идентификатор линии для отправки сообщений клиентам из настроек.
* Параметры.ТекущийСотрудник - СправочникСсылка.ФизическиеЛица - ссылка на физическое лицо текущего сотрудника.

Доступно только для контрагентов:

* Параметры.Контрагент - данные контрагента, реквизиты которого можно получать по точке.
* Параметры.ЗапретНаРаботуСКлиентом.ПричинаЗапрета - Строка - причина запрета, указанная при изменении статуса контрагента.
* Параметры.ЗапретНаРаботуСКлиентом.Комментарий - Строка - комментарий, указанный при изменении статуса контрагента.
* Параметры.ЗапретНаРаботуСКлиентом.ОтправлятьСообщениеКлиенту - значение указанное в настройках переключателя при изменении статуса контрагента.
* Параметры.ЗапретНаРаботуСКлиентом.Отправитель - Строка - идентификатор сотрудника в 1С-Коннект из настроек.
* Параметры.ЗапретНаРаботуСКлиентом.ЛинияПоддержки - Строка - идентификатор линии для отправки сообщений сотрудникам в 1С-Коннект из настроек.
* Параметры.НастройкиПодсистемы.СотрудникиЛинииПоддержки - ТаблицаЗначений - содержит пользователей, подключенных к линии для отправки сообщений сотрудникам в 1С-Коннект из настроек.
* Параметры.ЗапретНаРаботуСКлиентом.ПользователиПодключенныеКЛинии - ТаблицаЗначений - содержит пользователей, подключенных к линии для отправки сообщений сотрудникам в 1С-Коннект из настроек.
* Параметры.КоличествоЗапусков - Число - если при изменении статуса был установлен список клиентов, то тогда в этот параметр устанавливается возможное число запусков.
* Параметры.СписокКонтрагентовПредставление - Строка - перечисление списка контрагентов, с кем запрещена работа, в виде строки.

Доступно только для документа Расходная накладная и справочника Договоры контрагентов:

* Параметры.Объект - текущий объект, реквизиты которого можно получать по точке.



Также можно использовать перечисления конфигурации, системные перечисления, предопределенные элементы объектов.

Нельзя использовать условные операторы. Вместо классического Если-Иначе допускается использовать тернарный оператор ```?(<Условие>, <Значение если Истина>, <Значение если Ложь>)```.
Пример:

```

Мы очень рады работать с [
    ?(Параметры.Контрагент.СегментРынка = Перечисления.СК_БюджетХозрасчет.Бюджет,
    "вашим учреждением",
    "вашей компанией")
]. Благодарим за обращение. Были рады помочь.

```

Рассмотрим настройки роботов.

### Настройка робота Отправить сообщение сотруднику компании в 1С-Коннект

Откроем список статусов для документа ``Расходная накладная``.
Создадим статус ``Проверен`` и заполним настройки:

![Карточка клиента](https://sorokinltd.github.io/franchisee-manag-doc.github.io/img/status-rn.png)

Перейдем на вкладку ``Роботы`` и добавим робота ``Отправить сообщение сотруднику компании в 1С-Коннект``.

Заполним настройки:

![Настройки робота](https://sorokinltd.github.io/franchisee-manag-doc.github.io/img/sender-message-to-connect.png)

Здесь мы в условии запуска установили такое выражение:
``ПараметрыСеанса.ТекущийПользователь = Параметры.Объект.Автор``
Оно означает, что робот запустится только тогда, когда текущий пользователь совпадет с автором документа.
Для получения реквизитов объекта нужно указать выражение ``Параметры.Объект`` и тогда станут доступны реквизиты объекта.

В поле ``Отправитель`` мы указали выражение ``Параметры.НастройкиПодсистемы.АвторСообщений``. Значение берется из настроек подсистемы.

Чтобы заполнить поле ``Получатель`` требуется узнать идентификатор пользователя, которому нужно будет отправлять сообщение.

Для этого можно открыть веб-версию 1С-Коннект по [ссылке](https://web.1c-connect.com/)

После авторизации нужно перейти в раздел ``Коллеги`` и найти пользователя, которому хотим отправить сообщение:

![Настройки робота](https://sorokinltd.github.io/franchisee-manag-doc.github.io/img/2023-03-27_00-11-00.png)

Идентификатор нужно скопировать и вставить в поле ``Получатель`` в двойных кавычках:
``"идентификатор"``
Аналогично идентификатор можно установить и в поле отправитель.

В текст сообщения вставим такой шаблон:
``Статус документа [Параметры.Объект.Номер] изменен на "Проверен".``

Нажмем ``Сохранить``, сохраним статус.

Перейдем в какой-нибудь документ ``Расходная накладная`` и поменяем статус на тот, что мы только что создали и запишем документ.

В 1С-Коннект должно было отправиться сообщение примерно с таким текстом:

![Настройки робота](https://sorokinltd.github.io/franchisee-manag-doc.github.io/img/2023-03-27_00-24-55.png)

Если ничего не произошло, то можно попыться найти ошибку в журнале регистрации.
Названия ошибок должны начинаться с префикса ``СК_Робот``.

## Как работать со статусами

Откроем документ ``Расходная накладная``.
На командной панели документа должна была появиться кнопка ``Статус``

![Статусы на командной панели](https://sorokinltd.github.io/franchisee-manag-doc.github.io/img/statuses-on-form.png)

Если нажать на кнопку, раскроется список статусов из справочника ``Статусы объектов``.

Чтобы изменить статус, нужно нажать на статус. Тогда возле отмеченного статуса отобразится ``зеленая галочка``.
Чтобы подтвердить изменение статуса, нужно записать объект.

Аналогично работает и для договоров.
Для контрагентов принцип изменения статусов немного другой.

На форме контрагента нужно нажать на кнопку ``Изменить статус``.
![Статусы на форме контрагента](https://sorokinltd.github.io/franchisee-manag-doc.github.io/img/status-on-form-customer.png)

Затем откроется форма изменения статуса. Подробнее см. [здесь](https://sorokinltd.github.io/franchisee-manag-doc.github.io/docs/status-customer)

Список доступных статусов на форме изменения статусов у контрагента тоже можно менять.
